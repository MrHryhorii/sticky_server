openapi: 3.0.0
info:
  title: Notes, Products, and Orders API
  version: 1.0.0
  description: API for user notes, secure product catalog (menu), and order processing (stored as JSON in notes).

servers:
  - url: http://localhost:9001/api
    description: Development Server Base URL

# =======================================================
# PATHS (Endpoints)
# =======================================================
paths:
  # --- 1. AUTH ROUTES ---
  /auth/register:
    post:
      tags:
        - Authentication
      summary: Register a new user account.
      operationId: registerUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/auth_input"
      responses:
        "201":
          description: User created successfully.
        "400":
          description: Validation error or username already exists.

  /auth/login:
    post:
      tags:
        - Authentication
      summary: Log in and receive a JWT token.
      operationId: loginUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/auth_input"
      responses:
        "200":
          description: Successful login, returns JWT in the response body or cookies.
        "401":
          description: Invalid credentials.

  /auth/me:
    get:
      tags:
        - Authentication
      summary: Get details of the current authenticated user.
      operationId: getMe
      security:
        - BearerAuth: []
      responses:
        "200":
          description: User details returned successfully.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/user_response"
        "401":
          description: Unauthorized (Token missing or invalid).

  /auth/delete-account:
    delete:
      tags:
        - Authentication
      summary: Delete the current authenticated user's account.
      operationId: deleteSelf
      security:
        - BearerAuth: []
      responses:
        "204":
          description: Account successfully deleted.
        "401":
          description: Unauthorized.

  # --- 2. PUBLIC PRODUCT ROUTES (MENU) ---
  /products:
    get:
      tags:
        - Products (Public Menu)
      summary: Get list of all active products (menu).
      operationId: listActiveProducts
      responses:
        "200":
          description: List of active products returned.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/product_response"
        "500":
          description: Internal server error.

  /products/{id}:
    get:
      tags:
        - Products (Public Menu)
      summary: Get details of a single active product by ID.
      operationId: getSingleActiveProduct
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Product details returned.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/product_response"
        "404":
          description: Product not found or is inactive.

  # --- 3. USER NOTE ROUTES (CRUD) ---
  /notes:
    get:
      tags:
        - Notes (User)
      summary: Get list of all notes created by the current user.
      operationId: getNotes
      security:
        - BearerAuth: []
      responses:
        "200":
          description: List of user's notes returned.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/note_response"
    post:
      tags:
        - Notes (User)
      summary: Create a new note.
      operationId: createNote
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/note_input"
      responses:
        "201":
          description: Note successfully created.

  /notes/{id}:
    get:
      tags:
        - Notes (User)
      summary: Get a single note by ID (must be owned by the user).
      operationId: getNote
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Note details returned.
        "404":
          description: Note not found or not owned by user.
    put:
      tags:
        - Notes (User)
      summary: Update an existing note (cannot update orders).
      operationId: updateNote
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/note_input"
      responses:
        "200":
          description: Note successfully updated.
        "403":
          description: Forbidden (cannot update an Order record).
        "404":
          description: Note not found or not owned by user.
    delete:
      tags:
        - Notes (User)
      summary: Delete an existing note (cannot delete orders).
      operationId: deleteNote
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "204":
          description: Note successfully deleted (No Content).
        "403":
          description: Forbidden (cannot delete an Order record).

  # --- 4. USER ORDER ROUTES (CREATE AND READ) ---
  /orders:
    get:
      tags:
        - Orders (User)
      summary: Get list of all orders placed by the current user.
      operationId: getOrders
      security:
        - BearerAuth: []
      responses:
        "200":
          description: List of user's orders returned.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/order_response"
    post:
      tags:
        - Orders (User)
      summary: Create a new order (items must be active products).
      operationId: createOrder
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/order_input"
      responses:
        "201":
          description: Order successfully created, returns orderId.
        "400":
          description: Validation error (e.g., empty order).
        "404":
          description: Product item not available or inactive.

  /orders/{id}:
    get:
      tags:
        - Orders (User)
      summary: Get details of a single order by ID (must be owned by the user).
      operationId: getOrderById
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Order details returned.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/order_response"
        "404":
          description: Order not found or not owned by user.

  # --- 5. ADMIN MANAGEMENT ROUTES ---
  /admin/users:
    get:
      tags:
        - Admin: Users
      summary: Get list of all users.
      operationId: adminListUsers
      security:
        - BearerAuth: []
      responses:
        "200":
          description: List of all users returned.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/user_response"
        "403":
          description: Forbidden (Admin access required).

  /admin/users/{id}:
    delete:
      tags:
        - Admin: Users
      summary: Delete a user by ID.
      operationId: adminDeleteUser
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "204":
          description: User successfully deleted.
        "403":
          description: Forbidden (Admin access required).

  /admin/notes:
    get:
      tags:
        - Admin: Notes
      summary: Get list of all notes from all users.
      operationId: adminListAllNotes
      security:
        - BearerAuth: []
      parameters:
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 10
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            default: 0
      responses:
        "200":
          description: List of all notes returned (includes orders).
          content:
            application/json:
              schema:
                type: object
                properties:
                  notes:
                    type: array
                    items:
                      $ref: "#/components/schemas/note_response"
                  totalCount:
                    type: integer
        "403":
          description: Forbidden (Admin access required).

  /admin/notes/{id}:
    delete:
      tags:
        - Admin: Notes
      summary: Delete a specific note/order record by ID.
      operationId: adminDeleteNote
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "204":
          description: Note successfully deleted.
        "403":
          description: Forbidden (Admin access required).

  # --- 6. ADMIN ORDER MANAGEMENT ROUTES ---
  /admin/orders:
    get:
      tags:
        - "Admin: Orders"
      summary: Get a list of all orders (from all users) with pagination.
      operationId: adminListAllOrders
      security:
        - BearerAuth: []
      parameters:
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 10
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            default: 0
      responses:
        "200":
          description: List of all orders returned.
          content:
            application/json:
              schema:
                type: object
                properties:
                  orders:
                    type: array
                    items:
                      $ref: "#/components/schemas/order_response"
                  totalCount:
                    type: integer
        "403":
          description: Forbidden (Admin access required).

  /admin/orders/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
        description: The ID of the order (which is the note ID).
    
    get:
      tags:
        - "Admin: Orders"
      summary: Get details of a single order by ID, regardless of user.
      operationId: adminGetOrder
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Order details returned.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/order_response"
        "404":
          description: Order not found.
        "403":
          description: Forbidden (Admin access required).

  /admin/orders/{id}/status:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
        description: The ID of the order (which is the note ID).
    put:
      tags:
        - "Admin: Orders"
      summary: Update the status of a specific order.
      operationId: updateOrderStatus

  /admin/orders/{id}/status:
    put:
      tags:
        - Admin: Orders
      summary: Update the status of a specific order.
      operationId: updateOrderStatus
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/order_status_update_input"
      responses:
        "200":
          description: Order status updated successfully.
        "403":
          description: Forbidden (Admin access required).
        "404":
          description: Order not found.

  # --- 7. ADMIN PRODUCT MANAGEMENT ROUTES (CRUD) ---
  /admin/products:
    get:
      tags:
        - Admin: Products
      summary: Get list of all products (active and inactive).
      operationId: listAllProductsAdmin
      security:
        - BearerAuth: []
      responses:
        "200":
          description: List of all products returned.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/product_full_response"
        "403":
          description: Forbidden (Admin access required).
    post:
      tags:
        - Admin: Products
      summary: Create a new product.
      operationId: createProductAdmin
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/product_create_input"
      responses:
        "201":
          description: Product successfully created.
        "400":
          description: Validation failed.

  /admin/products/{id}:
    put:
      tags:
        - Admin: Products
      summary: Update an existing product (partial update allowed).
      operationId: updateProduct
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/product_update_input"
      responses:
        "200":
          description: Product successfully updated.
        "404":
          description: Product not found.

    delete:
      tags:
        - Admin: Products
      summary: Delete a product by ID.
      operationId: deleteProduct
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "204":
          description: Product successfully deleted.
        "404":
          description: Product not found.

# =======================================================
# COMPONENTS (Reusable Schemas & Security)
# =======================================================
components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # --- AUTH SCHEMAS ---
    auth_input:
      type: object
      properties:
        username:
          type: string
          example: testuser
        password:
          type: string
          example: 12345678
      required:
        - username
        - password

    user_response:
      type: object
      properties:
        id:
          type: integer
          example: 1
        username:
          type: string
          example: testuser
        role:
          type: string
          enum: [user, admin]
          example: user

    # --- NOTE SCHEMAS ---
    note_input:
      type: object
      properties:
        title:
          type: string
          example: My first note
        content:
          type: string
          example: The content of my private note.
      required:
        - title
        - content

    note_response:
      type: object
      description: A note record. Order data is NOT parsed here.
      properties:
        id:
          type: integer
          example: 10
        title:
          type: string
          example: My first note
        content:
          type: string
          description: For orders, this contains the JSON payload of the order.
          example: '{"total_amount": 45.97, "status": "PENDING", ...}'
        user_id:
          type: integer
          example: 2
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
      required:
        - id
        - user_id
        - title
        - content

    # --- PRODUCT SCHEMAS ---
    product_response:
      type: object
      description: Public view of a product.
      properties:
        id:
          type: integer
          example: 1
        name:
          type: string
          example: Espresso
        description:
          type: string
          example: Strong black coffee.
        price:
          type: number
          format: float
          example: 2.50
        category:
          type: string
          example: Coffee
        tags:
          type: string
          description: Comma-separated tags (e.g., 'hot, new').
          example: hot, caffeinated
        image_url:
          type: string
          format: url
      required:
        - id
        - name
        - price

    product_full_response:
      allOf:
        - $ref: "#/components/schemas/product_response"
        - type: object
          description: Full admin view of a product.
          properties:
            is_active:
              type: integer
              enum: [0, 1]
              example: 1
            created_at:
              type: string
              format: date-time
            updated_at:
              type: string
              format: date-time
            created_by_id:
              type: integer
              example: 1
          required:
            - is_active

    product_create_input:
      type: object
      properties:
        name:
          type: string
          example: Cappuccino
        description:
          type: string
          example: Espresso with steamed milk and foam.
        price:
          type: number
          format: float
          example: 4.00
        category:
          type: string
          example: Coffee
        tags:
          type: string
          example: hot, milk
        image_url:
          type: string
          format: url
        is_active:
          type: boolean
          example: true
      required:
        - name
        - price

    product_update_input:
      allOf:
        - $ref: "#/components/schemas/product_create_input"
        - type: object
          description: Partial update is allowed.

    # --- ORDER SCHEMAS ---
    order_input_item:
      type: object
      properties:
        productId:
          type: integer
          example: 1
        quantity:
          type: integer
          example: 2
      required:
        - productId
        - quantity

    order_input:
      type: array
      items:
        $ref: "#/components/schemas/order_input_item"
      description: Array of product IDs and quantities for a new order.
      example:
        - productId: 1
          quantity: 2
        - productId: 5
          quantity: 1

    order_response_item:
      type: object
      properties:
        productId:
          type: integer
          example: 1
        name:
          type: string
          example: Espresso
        price:
          type: number
          format: float
          example: 2.50
        quantity:
          type: integer
          example: 2
        total:
          type: number
          format: float
          example: 5.00
      required:
        - productId
        - name
        - price
        - quantity
        - total

    order_response:
      type: object
      description: A full order record fetched and parsed from the notes content.
      properties:
        orderId:
          type: integer
          example: 50
          description: The ID of the note record that stores this order.
        title:
          type: string
          example: Order placed on 10/25/2024
        user_id:
          type: integer
          example: 2
        order_date:
          type: string
          format: date-time
        status:
          type: string
          enum: [PENDING, IN_PROGRESS, READY, DELIVERED, CANCELLED]
          example: PENDING
        total_amount:
          type: number
          format: float
          example: 45.97
        order_items:
          type: array
          items:
            $ref: "#/components/schemas/order_response_item"
      required:
        - orderId
        - user_id
        - total_amount
        - order_items

    order_status_update_input:
      type: object
      description: Input required to update the status of an order.
      properties:
        status:
          type: string
          enum: [PENDING, IN_PROGRESS, READY, DELIVERED, CANCELLED]
          example: DELIVERED
      required:
        - status
